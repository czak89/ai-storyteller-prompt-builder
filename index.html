<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Story Writing Prompt Builder - Enhanced UX</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Enhanced Color Palette - Light Mode */
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            --primary-color: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            
            --secondary-gradient: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            --secondary-color: #f59e0b;
            
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --info-color: #3b82f6;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --bg-accent: #e0e7ff;
            --bg-body: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            
            --border-light: #e2e8f0;
            --border-medium: #cbd5e1;
            --border-dark: #94a3b8;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            --font-family-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-family-mono: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            
            --transition-fast: 0.15s ease-out;
            --transition-normal: 0.25s ease-out;
            --transition-slow: 0.35s ease-out;
            --transition-theme: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Dark Mode Color Palette */
        [data-theme="dark"] {
            --primary-gradient: linear-gradient(135deg, #7c3aed 0%, #a855f7 50%, #c084fc 100%);
            --primary-color: #8b5cf6;
            --primary-light: #a78bfa;
            --primary-dark: #7c3aed;
            
            --secondary-gradient: linear-gradient(135deg, #f59e0b 0%, #fb923c 100%);
            --secondary-color: #f59e0b;
            
            --success-color: #34d399;
            --warning-color: #fbbf24;
            --error-color: #f87171;
            --info-color: #60a5fa;
            
            --bg-primary: #1e293b;
            --bg-secondary: #334155;
            --bg-tertiary: #475569;
            --bg-accent: #4c1d95;
            --bg-body: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            
            --border-light: #475569;
            --border-medium: #64748b;
            --border-dark: #94a3b8;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.3);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.5), 0 4px 6px -4px rgb(0 0 0 / 0.4);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.6), 0 8px 10px -6px rgb(0 0 0 / 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-sans);
            background: var(--bg-body);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background var(--transition-theme), color var(--transition-theme);
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Enhanced Header */
        .header {
            background: var(--primary-gradient);
            color: white;
            padding: var(--spacing-xl) var(--spacing-lg);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: background var(--transition-theme);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
        }

        .header-content {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            background: linear-gradient(45deg, #ffffff, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.125rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .header-controls {
            position: absolute;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            z-index: 10;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-lg);
            padding: var(--spacing-sm);
            color: white;
            cursor: pointer;
            transition: all var(--transition-fast);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .theme-icon {
            font-size: 1rem;
            transition: transform var(--transition-theme);
        }

        [data-theme="dark"] .theme-icon.sun {
            transform: rotate(180deg);
        }

        [data-theme="light"] .theme-icon.moon {
            transform: rotate(-180deg);
        }

        /* Enhanced Main Layout */
        .main-container {
            flex: 1;
            padding: var(--spacing-xl);
            max-width: 1800px;
            margin: 0 auto;
            width: 100%;
        }

        .panels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: var(--spacing-xl);
            min-height: 800px;
        }

        /* Enhanced Panel Design */
        .panel {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transition: all var(--transition-normal), background var(--transition-theme), border-color var(--transition-theme), box-shadow var(--transition-theme);
            border: 1px solid var(--border-light);
            position: relative;
        }

        .panel:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px);
        }

        .panel-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-light);
            position: relative;
            transition: border-color var(--transition-theme);
        }

        .panel-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .panel-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .panel-content {
            padding: var(--spacing-lg);
            height: calc(100% - 80px);
            overflow-y: auto;
        }

        /* Enhanced Form Styling */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-family: var(--font-family-sans);
            transition: all var(--transition-fast), background var(--transition-theme), color var(--transition-theme), border-color var(--transition-theme);
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgb(99 102 241 / 0.1);
            background: var(--bg-primary);
        }

        .form-input:hover,
        .form-select:hover,
        .form-textarea:hover {
            border-color: var(--border-medium);
        }

        /* Enhanced Checkbox Group */
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .checkbox-item:hover {
            background: var(--bg-secondary);
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-color);
            cursor: pointer;
        }

        .checkbox-item label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 400;
        }

        /* Enhanced Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            font-family: var(--font-family-sans);
            cursor: pointer;
            transition: all var(--transition-fast);
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--secondary-gradient);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-outline:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
        }

        .btn-sm {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.75rem;
        }

        .btn-lg {
            padding: var(--spacing-md) var(--spacing-xl);
            font-size: 1rem;
        }

        /* Enhanced Tabs */
        .tabs {
            display: flex;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xs);
            margin-bottom: var(--spacing-lg);
            transition: background var(--transition-theme);
        }

        .tab {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast), background var(--transition-theme), color var(--transition-theme);
            color: var(--text-secondary);
        }

        .tab.active {
            background: var(--bg-primary);
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        .tab:hover:not(.active) {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        /* Enhanced Content Areas */
        .content-area {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            min-height: 300px;
            position: relative;
            transition: background var(--transition-theme), border-color var(--transition-theme);
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-light);
            transition: border-color var(--transition-theme);
        }

        .content-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .content-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        /* Enhanced Code Display */
        .code-output {
            font-family: var(--font-family-mono);
            font-size: 0.8rem;
            line-height: 1.5;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            max-height: 400px;
            overflow-y: auto;
            position: relative;
            transition: background var(--transition-theme), color var(--transition-theme), border-color var(--transition-theme);
        }

        .code-output::-webkit-scrollbar {
            width: 6px;
        }

        .code-output::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 3px;
            transition: background var(--transition-theme);
        }

        .code-output::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: 3px;
            transition: background var(--transition-theme);
        }

        .code-output::-webkit-scrollbar-thumb:hover {
            background: var(--border-dark);
        }

        /* Enhanced Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.8rem;
            font-weight: 500;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-disconnected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
        }

        .status-disconnected .status-dot {
            background: var(--error-color);
        }

        .status-connecting {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .status-connecting .status-dot {
            background: var(--warning-color);
        }

        .status-connected {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .status-connected .status-dot {
            background: var(--success-color);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Enhanced Messages */
        .message {
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin: var(--spacing-sm) 0;
            font-size: 0.875rem;
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-sm);
        }

        .message-icon {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .message-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .message-error .message-icon {
            background: var(--error-color);
            color: white;
        }

        .message-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .message-success .message-icon {
            background: var(--success-color);
            color: white;
        }

        .message-info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info-color);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .message-info .message-icon {
            background: var(--info-color);
            color: white;
        }

        /* Enhanced Progress Bar */
        .progress-container {
            margin: var(--spacing-md) 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            width: 0%;
            transition: width var(--transition-normal);
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Enhanced Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: currentColor;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Enhanced Placeholder */
        .placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-muted);
            min-height: 200px;
        }

        .placeholder-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }

        .placeholder-title {
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: var(--spacing-sm);
            color: var(--text-secondary);
        }

        .placeholder-text {
            font-size: 0.875rem;
            line-height: 1.6;
            max-width: 300px;
        }

        /* Enhanced Responsive Design */
        @media (max-width: 1400px) {
            .panels-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 1000px) {
            .panels-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-lg);
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .main-container {
                padding: var(--spacing-lg);
            }
        }

        @media (max-width: 640px) {
            .header {
                padding: var(--spacing-lg) var(--spacing-md);
            }
            
            .header h1 {
                font-size: 1.75rem;
            }
            
            .header-controls {
                position: static;
                justify-content: center;
                margin-bottom: var(--spacing-md);
            }
            
            .main-container {
                padding: var(--spacing-md);
            }
            
            .panel-content {
                padding: var(--spacing-md);
            }
            
            .checkbox-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                text-align: center;
            }
        }

        /* Enhanced Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus styles */
        .btn:focus-visible,
        .form-input:focus-visible,
        .form-select:focus-visible,
        .form-textarea:focus-visible,
        .tab:focus-visible,
        .theme-toggle:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Enhanced Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-10px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Enhanced Tooltips */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-fast);
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        /* Enhanced Feature Highlights */
        .feature-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--primary-gradient);
            color: white;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: var(--spacing-md);
            transition: background var(--transition-theme);
        }

        .feature-badge-icon {
            font-size: 0.875rem;
        }

        /* Enhanced Subgenre Selector */
        .subgenre-container {
            margin-top: var(--spacing-sm);
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all var(--transition-normal);
        }

        .subgenre-container.show {
            opacity: 1;
            max-height: 100px;
        }

        /* Enhanced Theme Examples */
        .theme-examples {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-sm);
        }

        .theme-example {
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--text-secondary);
        }

        .theme-example:hover {
            background: var(--bg-accent);
            color: var(--primary-color);
            border-color: var(--primary-light);
        }

        /* Enhanced Comparison View */
        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .comparison-panel {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .comparison-header {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-secondary);
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-light);
        }

        .comparison-content {
            padding: var(--spacing-md);
            font-size: 0.8rem;
            line-height: 1.5;
            color: var(--text-secondary);
            max-height: 200px;
            overflow-y: auto;
        }

        /* Enhanced API Key Input */
        .api-key-container {
            position: relative;
        }

        .api-key-toggle {
            position: absolute;
            right: var(--spacing-sm);
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.875rem;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }

        .api-key-toggle:hover {
            color: var(--text-secondary);
            background: var(--bg-secondary);
        }

        /* Enhanced Model List */
        .model-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-sm);
            background: var(--bg-primary);
            box-shadow: var(--shadow-md);
        }

        .model-item {
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            font-size: 0.8rem;
            border-bottom: 1px solid var(--border-light);
            transition: all var(--transition-fast);
            color: var(--text-secondary);
        }

        .model-item:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .model-item:last-child {
            border-bottom: none;
        }

        /* Enhanced Preset Buttons */
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
        }

        .preset-btn {
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--text-secondary);
            text-align: center;
        }

        .preset-btn:hover {
            background: var(--bg-accent);
            color: var(--primary-color);
            border-color: var(--primary-light);
            transform: translateY(-1px);
        }

        /* Enhanced Story Input */
        .story-input {
            width: 100%;
            min-height: 150px;
            padding: var(--spacing-md);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-family: Georgia, serif;
            line-height: 1.6;
            resize: vertical;
            transition: all var(--transition-fast);
            background: var(--bg-primary);
        }

        .story-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgb(99 102 241 / 0.1);
        }

        .story-input::placeholder {
            color: var(--text-muted);
            font-style: italic;
        }

        /* Enhanced Button Groups */
        .button-group {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .button-group .btn {
            flex: 1;
        }

        /* Enhanced Dark Mode Support - Auto Detection */
        @media (prefers-color-scheme: dark) {
            :root:not([data-theme]) {
                --primary-gradient: linear-gradient(135deg, #7c3aed 0%, #a855f7 50%, #c084fc 100%);
                --primary-color: #8b5cf6;
                --primary-light: #a78bfa;
                --primary-dark: #7c3aed;
                
                --secondary-gradient: linear-gradient(135deg, #f59e0b 0%, #fb923c 100%);
                --secondary-color: #f59e0b;
                
                --success-color: #34d399;
                --warning-color: #fbbf24;
                --error-color: #f87171;
                --info-color: #60a5fa;
                
                --bg-primary: #1e293b;
                --bg-secondary: #334155;
                --bg-tertiary: #475569;
                --bg-accent: #4c1d95;
                --bg-body: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
                
                --text-primary: #f1f5f9;
                --text-secondary: #cbd5e1;
                --text-muted: #94a3b8;
                
                --border-light: #475569;
                --border-medium: #64748b;
                --border-dark: #94a3b8;
                
                --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
                --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.3);
                --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.5), 0 4px 6px -4px rgb(0 0 0 / 0.4);
                --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.6), 0 8px 10px -6px rgb(0 0 0 / 0.5);
            }
        }

        /* Smooth transitions for all theme-aware elements */
        * {
            transition: background-color var(--transition-theme), 
                       color var(--transition-theme), 
                       border-color var(--transition-theme), 
                       box-shadow var(--transition-theme);
        }

        /* Override transitions for elements that shouldn't animate */
        .loading-spinner,
        .progress-fill,
        .status-dot {
            transition: none !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-controls">
                <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
                    <span class="theme-icon sun">‚òÄÔ∏è</span>
                    <span class="theme-icon moon" style="display: none;">üåô</span>
                    <span class="theme-text">Light</span>
                </button>
            </div>
            <div class="header-content">
                <h1>ü§ñ AI Story Writing Prompt Builder</h1>
                <p>Enhanced UX Edition - Create, enhance, and test professional story writing prompts</p>
            </div>
        </header>
        
        <main class="main-container">
            <div class="panels-grid">
                <!-- Story Configuration Panel -->
                <div class="panel fade-in">
                    <div class="panel-header">
                        <div class="feature-badge">
                            <span class="feature-badge-icon">‚öôÔ∏è</span>
                            Enhanced Configuration
                        </div>
                        <h2 class="panel-title">
                            üìù Story Configuration
                        </h2>
                        <p class="panel-subtitle">Configure your story parameters with advanced options</p>
                    </div>
                    <div class="panel-content">
                        <form id="promptForm">
                            <div class="form-group">
                                <label for="genre" class="form-label">Story Genre</label>
                                <select id="genre" name="genre" class="form-select">
                                    <option value="general">General Fiction</option>
                                    <option value="fantasy">Fantasy</option>
                                    <option value="scifi">Science Fiction</option>
                                    <option value="mystery">Mystery/Thriller</option>
                                    <option value="romance">Romance</option>
                                    <option value="horror">Horror</option>
                                    <option value="historical">Historical Fiction</option>
                                    <option value="literary">Literary Fiction</option>
                                    <option value="cyberpunk">Cyberpunk</option>
                                    <option value="urban-fantasy">Urban Fantasy</option>
                                    <option value="steampunk">Steampunk</option>
                                    <option value="dystopian">Dystopian</option>
                                    <option value="western">Western</option>
                                    <option value="adventure">Adventure</option>
                                    <option value="comedy">Comedy</option>
                                    <option value="crime">Crime</option>
                                    <option value="psychological">Psychological</option>
                                    <option value="supernatural">Supernatural</option>
                                </select>
                                <div class="subgenre-container" id="subgenreContainer">
                                    <select id="subgenre" name="subgenre" class="form-select">
                                        <option value="">Select subgenre...</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="length" class="form-label">Story Length</label>
                                <select id="length" name="length" class="form-select">
                                    <option value="flash">Flash Fiction (< 1,000 words)</option>
                                    <option value="short">Short Story (1,000-5,000 words)</option>
                                    <option value="novelette">Novelette (7,500-17,500 words)</option>
                                    <option value="novella">Novella (17,500-40,000 words)</option>
                                    <option value="novel">Novel (40,000+ words)</option>
                                    <option value="epic">Epic Novel (100,000+ words)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="perspective" class="form-label">Narrative Perspective</label>
                                <select id="perspective" name="perspective" class="form-select">
                                    <option value="first">First Person</option>
                                    <option value="third-limited">Third Person Limited</option>
                                    <option value="third-omniscient">Third Person Omniscient</option>
                                    <option value="second">Second Person</option>
                                    <option value="multiple">Multiple POV</option>
                                    <option value="epistolary">Epistolary (Letters/Documents)</option>
                                    <option value="stream">Stream of Consciousness</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="tone" class="form-label">Story Tone</label>
                                <select id="tone" name="tone" class="form-select">
                                    <option value="dramatic">Dramatic</option>
                                    <option value="humorous">Humorous</option>
                                    <option value="dark">Dark/Gritty</option>
                                    <option value="uplifting">Uplifting</option>
                                    <option value="mysterious">Mysterious</option>
                                    <option value="romantic">Romantic</option>
                                    <option value="satirical">Satirical</option>
                                    <option value="melancholic">Melancholic</option>
                                    <option value="whimsical">Whimsical</option>
                                    <option value="noir">Noir</option>
                                    <option value="epic">Epic</option>
                                    <option value="intimate">Intimate</option>
                                    <option value="surreal">Surreal</option>
                                    <option value="philosophical">Philosophical</option>
                                    <option value="nostalgic">Nostalgic</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="theme" class="form-label">Central Theme</label>
                                <select id="theme" name="theme" class="form-select">
                                    <option value="">Select a theme...</option>
                                    <option value="redemption">Redemption</option>
                                    <option value="coming-of-age">Coming of Age</option>
                                    <option value="good-vs-evil">Good vs Evil</option>
                                    <option value="love-conquers-all">Love Conquers All</option>
                                    <option value="power-corruption">Power and Corruption</option>
                                    <option value="identity-search">Search for Identity</option>
                                    <option value="sacrifice">Sacrifice</option>
                                    <option value="betrayal">Betrayal</option>
                                    <option value="survival">Survival</option>
                                    <option value="justice">Justice</option>
                                    <option value="freedom">Freedom</option>
                                    <option value="family">Family Bonds</option>
                                    <option value="forgiveness">Forgiveness</option>
                                    <option value="truth">Truth vs Lies</option>
                                    <option value="mortality">Mortality</option>
                                    <option value="technology">Technology's Impact</option>
                                    <option value="nature">Man vs Nature</option>
                                    <option value="society">Individual vs Society</option>
                                    <option value="time">Time and Memory</option>
                                    <option value="hope">Hope in Darkness</option>
                                </select>
                                <input type="text" id="customTheme" name="customTheme" placeholder="Or enter custom theme..." class="form-input" style="margin-top: var(--spacing-sm); display: none;">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Advanced Features</label>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="plotTwists" name="features" value="plotTwists" checked>
                                        <label for="plotTwists">Plot Twists</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="settings" name="features" value="settings" checked>
                                        <label for="settings">Settings</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="dialogue" name="features" value="dialogue" checked>
                                        <label for="dialogue">Dialogue</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="pacing" name="features" value="pacing" checked>
                                        <label for="pacing">Pacing</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="characters" name="features" value="characters" checked>
                                        <label for="characters">Characters</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="worldbuilding" name="features" value="worldbuilding">
                                        <label for="worldbuilding">World Building</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="symbolism" name="features" value="symbolism">
                                        <label for="symbolism">Symbolism</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="conflict" name="features" value="conflict">
                                        <label for="conflict">Conflict Types</label>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary btn-lg">
                                üöÄ Generate Expert Prompt
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Generated Prompt Panel -->
                <div class="panel fade-in">
                    <div class="panel-header">
                        <div class="feature-badge">
                            <span class="feature-badge-icon">‚ú®</span>
                            AI Generated
                        </div>
                        <h2 class="panel-title">
                            üìÑ Generated Prompt
                        </h2>
                        <p class="panel-subtitle">Your comprehensive AI writing command</p>
                    </div>
                    <div class="panel-content">
                        <div class="content-area">
                            <div class="content-header">
                                <h3 class="content-title">Expert Writing Prompt</h3>
                                <div class="content-actions">
                                    <button class="btn btn-secondary btn-sm" id="enhanceBtn" style="display: none;">
                                        ‚ú® Enhance
                                    </button>
                                    <button class="btn btn-success btn-sm" id="copyBtn" style="display: none;">
                                        üìã Copy
                                    </button>
                                </div>
                            </div>
                            <div class="code-output" id="promptOutput">
                                <div class="placeholder">
                                    <div class="placeholder-icon">üìù</div>
                                    <div class="placeholder-title">Ready to Generate</div>
                                    <div class="placeholder-text">
                                        Configure your story parameters and click "Generate Expert Prompt" to create a comprehensive AI writing command.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Testing Panel -->
                <div class="panel fade-in">
                    <div class="panel-header">
                        <div class="feature-badge">
                            <span class="feature-badge-icon">üß†</span>
                            Multi-Provider
                        </div>
                        <h2 class="panel-title">
                            ü§ñ AI Testing Hub
                        </h2>
                        <p class="panel-subtitle">Test prompts with multiple AI providers</p>
                    </div>
                    <div class="panel-content">
                        <div class="status-indicator status-disconnected" id="statusIndicator">
                            <span class="status-dot"></span>
                            <span>Disconnected</span>
                        </div>

                        <div class="tabs">
                            <button class="tab active" data-mode="webllm">Browser AI</button>
                            <button class="tab" data-mode="openai">OpenAI API</button>
                            <button class="tab" data-mode="custom">Custom Endpoint</button>
                        </div>

                        <!-- WebLLM Mode -->
                        <div class="tab-content active" id="webllm-mode">
                            <div class="form-group">
                                <label for="webllmModelSelect" class="form-label">Select Model</label>
                                <select id="webllmModelSelect" class="form-select">
                                    <option value="">Choose a model...</option>
                                    <option value="Llama-3.2-1B-Instruct-q4f16_1-MLC">Llama 3.2 1B (Fast, 2GB)</option>
                                    <option value="Llama-3.2-3B-Instruct-q4f16_1-MLC">Llama 3.2 3B (Better, 4GB)</option>
                                    <option value="Phi-3.5-mini-instruct-q4f16_1-MLC">Phi 3.5 Mini (Efficient, 2GB)</option>
                                    <option value="gemma-2-2b-it-q4f16_1-MLC">Gemma 2 2B (Google, 2GB)</option>
                                </select>
                            </div>
                        </div>

                        <!-- OpenAI Mode -->
                        <div class="tab-content" id="openai-mode">
                            <div class="form-group">
                                <label for="openaiKey" class="form-label">API Key</label>
                                <div class="api-key-container">
                                    <input type="password" id="openaiKey" placeholder="sk-..." class="form-input">
                                    <button type="button" class="api-key-toggle" onclick="toggleApiKeyVisibility('openaiKey')">üëÅÔ∏è</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="openaiModelSelect" class="form-label">Model</label>
                                <select id="openaiModelSelect" class="form-select">
                                    <option value="gpt-4o-mini">GPT-4o Mini</option>
                                    <option value="gpt-4o">GPT-4o</option>
                                    <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                </select>
                            </div>
                        </div>

                        <!-- Custom Endpoint Mode -->
                        <div class="tab-content" id="custom-mode">
                            <div class="preset-grid">
                                <button class="preset-btn" data-preset="ollama">Ollama</button>
                                <button class="preset-btn" data-preset="lmstudio">LM Studio</button>
                                <button class="preset-btn" data-preset="textgen">Text Gen</button>
                                <button class="preset-btn" data-preset="vllm">vLLM</button>
                            </div>
                            
                            <div class="form-group">
                                <label for="customEndpoint" class="form-label">Base URL</label>
                                <input type="text" id="customEndpoint" placeholder="http://localhost:11434/v1" class="form-input">
                            </div>
                            
                            <div class="form-group">
                                <label for="customKey" class="form-label">API Key (Optional)</label>
                                <div class="api-key-container">
                                    <input type="password" id="customKey" placeholder="Leave empty if not required" class="form-input">
                                    <button type="button" class="api-key-toggle" onclick="toggleApiKeyVisibility('customKey')">üëÅÔ∏è</button>
                                </div>
                            </div>
                            
                            <button type="button" id="discoverModelsBtn" class="btn btn-outline">
                                üîç Discover Models
                            </button>
                            
                            <div class="form-group">
                                <label for="customModelSelect" class="form-label">Available Models</label>
                                <select id="customModelSelect" class="form-select">
                                    <option value="">Select or discover models...</option>
                                </select>
                            </div>
                            
                            <div id="discoveredModels" class="model-list" style="display: none;"></div>
                        </div>

                        <div id="modelMessages"></div>
                        
                        <div class="progress-container" id="progressContainer" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                        </div>

                        <button class="btn btn-primary btn-lg" id="testPromptBtn" disabled>
                            üß™ Test Generated Prompt
                        </button>

                        <div class="content-area" style="margin-top: var(--spacing-md);">
                            <div class="content-header">
                                <h3 class="content-title">AI Response</h3>
                            </div>
                            <div class="code-output" id="aiResponse">
                                <div class="placeholder">
                                    <div class="placeholder-icon">ü§ñ</div>
                                    <div class="placeholder-title">Ready for Testing</div>
                                    <div class="placeholder-text">
                                        Select and configure an AI model to test your generated prompts.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhancement Tools Panel -->
                <div class="panel fade-in">
                    <div class="panel-header">
                        <div class="feature-badge">
                            <span class="feature-badge-icon">‚ö°</span>
                            AI Powered
                        </div>
                        <h2 class="panel-title">
                            ‚ú® Enhancement Tools
                        </h2>
                        <p class="panel-subtitle">Improve prompts and extend stories with AI</p>
                    </div>
                    <div class="panel-content">
                        <div class="tabs">
                            <button class="tab active" data-enhancement="prompt">Prompt Enhancement</button>
                            <button class="tab" data-enhancement="story">Story Extension</button>
                        </div>

                        <!-- Prompt Enhancement -->
                        <div class="tab-content active" id="prompt-enhancement">
                            <div class="button-group">
                                <button class="btn btn-secondary" id="analyzePromptBtn" disabled>
                                    üîç Analyze Prompt
                                </button>
                                <button class="btn btn-secondary" id="improvePromptBtn" disabled>
                                    ‚ö° Improve Prompt
                                </button>
                            </div>
                            <div class="content-area">
                                <div class="content-header">
                                    <h3 class="content-title">Enhancement Results</h3>
                                </div>
                                <div class="code-output" id="promptEnhancementResult">
                                    <div class="placeholder">
                                        <div class="placeholder-icon">‚ú®</div>
                                        <div class="placeholder-title">Ready to Enhance</div>
                                        <div class="placeholder-text">
                                            Generate a prompt first, then use AI to analyze and improve it.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Story Extension -->
                        <div class="tab-content" id="story-extension">
                            <div class="form-group">
                                <label for="storyInput" class="form-label">Your Story</label>
                                <textarea class="story-input" id="storyInput" placeholder="Paste your existing story here to extend or fix continuity errors..."></textarea>
                            </div>
                            <div class="button-group">
                                <button class="btn btn-secondary" id="extendStoryBtn" disabled>
                                    üìñ Extend Story
                                </button>
                                <button class="btn btn-secondary" id="fixContinuityBtn" disabled>
                                    üîß Fix Continuity
                                </button>
                            </div>
                            <div class="content-area">
                                <div class="content-header">
                                    <h3 class="content-title">Story Enhancement</h3>
                                </div>
                                <div class="code-output" id="storyEnhancementResult">
                                    <div class="placeholder">
                                        <div class="placeholder-icon">üìö</div>
                                        <div class="placeholder-title">Ready to Enhance</div>
                                        <div class="placeholder-text">
                                            Enter your story text and select an enhancement option.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- WebLLM Library -->
    <script type="module">
        import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";

        class StoryPromptBuilderEnhancedUX {
            constructor() {
                this.initializeElements();
                this.initializeTheme();
                this.initializeEventListeners();
                this.templates = this.initializeTemplates();
                this.presets = this.initializePresets();
                this.subgenres = this.initializeSubgenres();
                
                this.engine = null;
                this.currentPrompt = '';
                this.currentMode = 'webllm';
                
                // Initialize UI state
                this.updateEnhancementButtons();
            }

            initializeElements() {
                // Theme elements
                this.themeToggle = document.getElementById('themeToggle');
                this.themeText = this.themeToggle.querySelector('.theme-text');
                this.sunIcon = this.themeToggle.querySelector('.sun');
                this.moonIcon = this.themeToggle.querySelector('.moon');
                
                // Form elements
                this.form = document.getElementById('promptForm');
                this.genreSelect = document.getElementById('genre');
                this.subgenreSelect = document.getElementById('subgenre');
                this.subgenreContainer = document.getElementById('subgenreContainer');
                this.themeSelect = document.getElementById('theme');
                this.customThemeInput = document.getElementById('customTheme');
                
                // Output elements
                this.output = document.getElementById('promptOutput');
                this.copyBtn = document.getElementById('copyBtn');
                this.enhanceBtn = document.getElementById('enhanceBtn');
                
                // AI elements
                this.statusIndicator = document.getElementById('statusIndicator');
                this.testPromptBtn = document.getElementById('testPromptBtn');
                this.aiResponse = document.getElementById('aiResponse');
                this.progressContainer = document.getElementById('progressContainer');
                this.progressFill = document.getElementById('progressFill');
                this.modelMessages = document.getElementById('modelMessages');
                
                // AI mode elements
                this.modeTabs = document.querySelectorAll('.tab[data-mode]');
                this.modeContents = document.querySelectorAll('.tab-content');
                this.webllmModelSelect = document.getElementById('webllmModelSelect');
                this.openaiModelSelect = document.getElementById('openaiModelSelect');
                this.openaiKey = document.getElementById('openaiKey');
                this.customEndpoint = document.getElementById('customEndpoint');
                this.customKey = document.getElementById('customKey');
                this.customModelSelect = document.getElementById('customModelSelect');
                this.discoverModelsBtn = document.getElementById('discoverModelsBtn');
                this.discoveredModels = document.getElementById('discoveredModels');
                
                // Enhancement elements
                this.enhancementTabs = document.querySelectorAll('.tab[data-enhancement]');
                this.enhancementContents = document.querySelectorAll('.tab-content');
                this.analyzePromptBtn = document.getElementById('analyzePromptBtn');
                this.improvePromptBtn = document.getElementById('improvePromptBtn');
                this.promptEnhancementResult = document.getElementById('promptEnhancementResult');
                this.storyInput = document.getElementById('storyInput');
                this.extendStoryBtn = document.getElementById('extendStoryBtn');
                this.fixContinuityBtn = document.getElementById('fixContinuityBtn');
                this.storyEnhancementResult = document.getElementById('storyEnhancementResult');
            }

            initializeTheme() {
                // Check for saved theme preference or default to system preference
                const savedTheme = localStorage.getItem('theme');
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                if (savedTheme) {
                    this.setTheme(savedTheme);
                } else if (systemPrefersDark) {
                    this.setTheme('dark');
                } else {
                    this.setTheme('light');
                }
                
                // Listen for system theme changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    if (!localStorage.getItem('theme')) {
                        this.setTheme(e.matches ? 'dark' : 'light');
                    }
                });
            }

            setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                this.updateThemeToggle(theme);
                
                // Save preference
                localStorage.setItem('theme', theme);
            }

            toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                this.setTheme(newTheme);
            }

            updateThemeToggle(theme) {
                if (theme === 'dark') {
                    this.sunIcon.style.display = 'none';
                    this.moonIcon.style.display = 'inline';
                    this.themeText.textContent = 'Dark';
                } else {
                    this.sunIcon.style.display = 'inline';
                    this.moonIcon.style.display = 'none';
                    this.themeText.textContent = 'Light';
                }
            }

            initializeEventListeners() {
                // Theme events
                this.themeToggle.addEventListener('click', () => this.toggleTheme());
                
                // Form events
                this.form.addEventListener('submit', (e) => this.handleSubmit(e));
                this.genreSelect.addEventListener('change', () => this.handleGenreChange());
                this.themeSelect.addEventListener('change', () => this.handleThemeChange());
                
                // Button events
                this.copyBtn.addEventListener('click', () => this.copyToClipboard());
                this.enhanceBtn.addEventListener('click', () => this.switchToPromptEnhancement());
                this.testPromptBtn.addEventListener('click', () => this.testPrompt());
                
                // AI mode events
                this.modeTabs.forEach(tab => {
                    tab.addEventListener('click', () => this.switchMode(tab.dataset.mode));
                });
                
                // Enhancement events
                this.enhancementTabs.forEach(tab => {
                    tab.addEventListener('click', () => this.switchEnhancementMode(tab.dataset.enhancement));
                });
                
                // Model events
                this.webllmModelSelect.addEventListener('change', () => this.handleWebLLMModelChange());
                this.openaiKey.addEventListener('input', () => this.validateOpenAIConfig());
                this.customEndpoint.addEventListener('input', () => this.validateCustomConfig());
                this.discoverModelsBtn.addEventListener('click', () => this.discoverModels());
                
                // Enhancement button events
                this.analyzePromptBtn.addEventListener('click', () => this.analyzePrompt());
                this.improvePromptBtn.addEventListener('click', () => this.improvePrompt());
                this.extendStoryBtn.addEventListener('click', () => this.extendStory());
                this.fixContinuityBtn.addEventListener('click', () => this.fixContinuity());
                this.storyInput.addEventListener('input', () => this.validateStoryInput());
                
                // Preset events
                document.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.applyPreset(btn.dataset.preset));
                });
            }

            initializeSubgenres() {
                return {
                    fantasy: ['High Fantasy', 'Urban Fantasy', 'Dark Fantasy', 'Epic Fantasy', 'Sword & Sorcery'],
                    scifi: ['Hard Science Fiction', 'Space Opera', 'Cyberpunk', 'Dystopian', 'Time Travel'],
                    mystery: ['Cozy Mystery', 'Police Procedural', 'Noir', 'Psychological Thriller', 'Legal Thriller'],
                    romance: ['Contemporary Romance', 'Historical Romance', 'Paranormal Romance', 'Romantic Suspense', 'Erotic Romance'],
                    horror: ['Gothic Horror', 'Psychological Horror', 'Supernatural Horror', 'Body Horror', 'Cosmic Horror'],
                    historical: ['Medieval', 'Victorian Era', 'World War Era', 'Ancient Civilizations', 'Renaissance'],
                    literary: ['Magical Realism', 'Experimental Fiction', 'Postmodern', 'Minimalist', 'Stream of Consciousness'],
                    cyberpunk: ['Classic Cyberpunk', 'Biopunk', 'Steampunk', 'Dieselpunk', 'Post-Cyberpunk'],
                    'urban-fantasy': ['Modern Urban Fantasy', 'Paranormal Romance', 'Dark Urban Fantasy', 'Contemporary Magic', 'Supernatural Detective'],
                    steampunk: ['Victorian Steampunk', 'Weird West', 'Steampunk Adventure', 'Alternate History', 'Clockwork Fantasy'],
                    dystopian: ['Post-Apocalyptic', 'Totalitarian', 'Environmental Collapse', 'Social Dystopia', 'Technological Dystopia'],
                    western: ['Classic Western', 'Weird West', 'Space Western', 'Modern Western', 'Revisionist Western'],
                    adventure: ['Action Adventure', 'Survival', 'Treasure Hunt', 'Exploration', 'Military Adventure'],
                    comedy: ['Romantic Comedy', 'Dark Comedy', 'Satirical Comedy', 'Absurdist Comedy', 'Parody'],
                    crime: ['Police Procedural', 'Heist', 'Organized Crime', 'True Crime', 'Vigilante'],
                    psychological: ['Psychological Thriller', 'Mind Games', 'Identity Crisis', 'Memory Loss', 'Split Personality'],
                    supernatural: ['Ghost Stories', 'Demon/Angel', 'Witchcraft', 'Vampires/Werewolves', 'Psychic Powers']
                };
            }

            initializePresets() {
                return {
                    ollama: {
                        baseUrl: 'http://localhost:11434/v1',
                        apiKey: '',
                        name: 'Ollama'
                    },
                    lmstudio: {
                        baseUrl: 'http://localhost:1234/v1',
                        apiKey: '',
                        name: 'LM Studio'
                    },
                    textgen: {
                        baseUrl: 'http://localhost:5000/v1',
                        apiKey: '',
                        name: 'Text Generation WebUI'
                    },
                    vllm: {
                        baseUrl: 'http://localhost:8000/v1',
                        apiKey: '',
                        name: 'vLLM'
                    }
                };
            }

            initializeTemplates() {
                return {
                    plotTwists: {
                        general: [
                            "The protagonist's trusted ally has been working against them all along",
                            "What seemed like the main conflict was actually a distraction from the real threat",
                            "The protagonist discovers they have a hidden connection to the antagonist",
                            "A character presumed dead returns at a crucial moment",
                            "The solution to the main problem creates an even bigger problem"
                        ],
                        fantasy: [
                            "The magical artifact the hero seeks is actually cursed or corrupted",
                            "The prophecy was misinterpreted or deliberately altered",
                            "The mentor figure is revealed to be the true dark lord",
                            "Magic comes with a terrible, hidden cost that's just now being revealed",
                            "The different realms/worlds are actually the same place in different time periods"
                        ],
                        scifi: [
                            "The AI/computer system has been manipulating events from the beginning",
                            "What they thought was the future is actually a simulation or virtual reality",
                            "The alien threat is actually future humans trying to prevent a catastrophe",
                            "Time travel has created a paradox that's unraveling reality",
                            "The technology they're using is actually alien in origin and has its own agenda"
                        ],
                        mystery: [
                            "The detective/investigator is actually connected to the crime",
                            "The victim faked their own death/disappearance",
                            "Multiple seemingly unrelated cases are actually connected",
                            "The evidence was planted by someone trying to frame an innocent person",
                            "The crime was committed for completely different reasons than initially suspected"
                        ],
                        cyberpunk: [
                            "The corporation the protagonist works for is actually run by an AI",
                            "The virtual reality world is bleeding into the real world",
                            "The protagonist's memories have been artificially implanted",
                            "The rebellion against the system is actually orchestrated by the system itself",
                            "The protagonist discovers they are not human but an advanced android"
                        ]
                    },
                    
                    settings: {
                        urban: "A bustling metropolis where glass towers pierce the sky, their surfaces reflecting the constant flow of humanity below. Streets pulse with the rhythm of traffic, street vendors, and the underground rumble of subway trains. Neon signs cast colorful shadows in narrow alleyways where secrets hide in plain sight.",
                        
                        rural: "Rolling hills stretch endlessly under an expansive sky, dotted with weathered farmhouses and ancient oak trees. The air carries the scent of wildflowers and fresh earth, while distant church bells mark the passage of time in a place where everyone knows their neighbor's story.",
                        
                        fantasy: "An enchanted realm where crystalline spires twist toward twin moons, and bioluminescent forests whisper ancient secrets. Magic crackles in the air like static electricity, and creatures of legend roam freely through landscapes that shift between breathtaking beauty and terrifying danger.",
                        
                        scifi: "A space station orbiting a dying star, its corridors humming with the constant thrum of life support systems. Holographic displays flicker with data streams while artificial gravity keeps inhabitants grounded in a world where 'up' and 'down' are merely suggestions.",
                        
                        historical: "Cobblestone streets wind between half-timbered buildings, their windows glowing with candlelight as the scent of woodsmoke and fresh bread drifts from chimneys. Horse-drawn carriages clatter past while merchants hawk their wares in a marketplace that's been the heart of the community for centuries.",
                        
                        cyberpunk: "Rain-slicked streets reflect the glow of holographic advertisements in a city where chrome and flesh merge seamlessly. Corporate arcologies pierce the smog-choked sky while underground, hackers and street samurai navigate the digital shadows of cyberspace."
                    },
                    
                    dialogue: {
                        conflict: '"You don\'t understand," she said, her voice barely above a whisper. "If I tell you the truth, everything changes. Everything we\'ve built together... it all falls apart."',
                        
                        revelation: '"The funny thing about secrets," he said, leaning back in his chair, "is that they have a way of revealing themselves when you least expect it. And this one? This one\'s been waiting twenty years to come out."',
                        
                        tension: '"We both know why you\'re really here," she said without looking up from her coffee. "The question is whether you\'re brave enough to admit it."',
                        
                        emotional: '"I used to think courage meant not being afraid," he said, staring out at the storm. "Now I know it means being terrified and doing what\'s right anyway."'
                    },
                    
                    pacing: {
                        opening: "Start with immediate action or compelling dialogue. Establish the protagonist's normal world quickly, then introduce the inciting incident within the first 10-15% of your story.",
                        
                        middle: "Escalate conflicts progressively. Each scene should either advance the plot or develop character. Use the 'yes, but' or 'no, and' principle - if something goes right for your protagonist, add a complication.",
                        
                        climax: "Build to the climax through a series of increasingly intense obstacles. The final confrontation should test everything your protagonist has learned and force them to make their most difficult choice.",
                        
                        resolution: "Provide emotional satisfaction while tying up loose ends. Show how your protagonist has changed, but leave some questions for readers to ponder."
                    }
                };
            }

            handleGenreChange() {
                const selectedGenre = this.genreSelect.value;
                const subgenres = this.subgenres[selectedGenre];
                
                if (subgenres) {
                    this.subgenreSelect.innerHTML = '<option value="">Select subgenre...</option>';
                    subgenres.forEach(subgenre => {
                        const option = document.createElement('option');
                        option.value = subgenre.toLowerCase().replace(/\s+/g, '-');
                        option.textContent = subgenre;
                        this.subgenreSelect.appendChild(option);
                    });
                    this.subgenreContainer.classList.add('show');
                } else {
                    this.subgenreContainer.classList.remove('show');
                }
            }

            handleThemeChange() {
                if (this.themeSelect.value === 'custom') {
                    this.customThemeInput.style.display = 'block';
                    this.customThemeInput.focus();
                } else {
                    this.customThemeInput.style.display = 'none';
                }
            }

            switchMode(mode) {
                this.currentMode = mode;
                
                // Update tabs
                this.modeTabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.mode === mode);
                });
                
                // Update content
                this.modeContents.forEach(content => {
                    content.classList.toggle('active', content.id === `${mode}-mode`);
                });
                
                // Reset status
                this.updateStatus('disconnected');
                this.testPromptBtn.disabled = true;
                this.clearMessages();
                
                // Validate current configuration
                this.validateCurrentMode();
                this.updateEnhancementButtons();
            }

            switchEnhancementMode(mode) {
                // Update tabs
                this.enhancementTabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.enhancement === mode);
                });
                
                // Update content
                this.enhancementContents.forEach(content => {
                    content.classList.toggle('active', content.id === `${mode}-enhancement`);
                });
                
                // Update button states
                this.updateEnhancementButtons();
            }

            switchToPromptEnhancement() {
                this.switchEnhancementMode('prompt');
                
                // Smooth scroll to enhancement section
                document.querySelector('.panel:last-child').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest' 
                });
            }

            validateCurrentMode() {
                switch (this.currentMode) {
                    case 'webllm':
                        if (this.webllmModelSelect.value) {
                            this.handleWebLLMModelChange();
                        }
                        break;
                    case 'openai':
                        this.validateOpenAIConfig();
                        break;
                    case 'custom':
                        this.validateCustomConfig();
                        break;
                }
            }

            validateOpenAIConfig() {
                const hasKey = this.openaiKey.value.trim().length > 0;
                const hasModel = this.openaiModelSelect.value.length > 0;
                
                if (hasKey && hasModel) {
                    this.updateStatus('connected');
                    this.testPromptBtn.disabled = false;
                    this.showMessage('success', 'OpenAI configuration ready');
                } else {
                    this.updateStatus('disconnected');
                    this.testPromptBtn.disabled = true;
                    if (!hasKey) {
                        this.showMessage('info', 'Enter your OpenAI API key to continue');
                    }
                }
                this.updateEnhancementButtons();
            }

            validateCustomConfig() {
                const hasEndpoint = this.customEndpoint.value.trim().length > 0;
                const hasModel = this.customModelSelect.value.length > 0;
                
                if (hasEndpoint && hasModel) {
                    this.updateStatus('connected');
                    this.testPromptBtn.disabled = false;
                    this.showMessage('success', 'Custom endpoint configuration ready');
                } else {
                    this.updateStatus('disconnected');
                    this.testPromptBtn.disabled = true;
                    if (!hasEndpoint) {
                        this.showMessage('info', 'Enter endpoint URL and discover models');
                    }
                }
                this.updateEnhancementButtons();
            }

            updateEnhancementButtons() {
                const hasPrompt = this.currentPrompt.length > 0;
                const hasStory = this.storyInput.value.trim().length > 0;
                const hasAI = this.isAIReady();
                
                this.analyzePromptBtn.disabled = !hasPrompt || !hasAI;
                this.improvePromptBtn.disabled = !hasPrompt || !hasAI;
                this.extendStoryBtn.disabled = !hasStory || !hasAI;
                this.fixContinuityBtn.disabled = !hasStory || !hasAI;
            }

            validateStoryInput() {
                this.updateEnhancementButtons();
            }

            isAIReady() {
                switch (this.currentMode) {
                    case 'webllm':
                        return this.engine !== null;
                    case 'openai':
                        return this.openaiKey.value.trim().length > 0 && this.openaiModelSelect.value.length > 0;
                    case 'custom':
                        return this.customEndpoint.value.trim().length > 0 && this.customModelSelect.value.length > 0;
                    default:
                        return false;
                }
            }

            updateStatus(status) {
                const statusMap = {
                    disconnected: { text: 'Disconnected', class: 'status-disconnected' },
                    connecting: { text: 'Connecting...', class: 'status-connecting' },
                    connected: { text: 'Connected', class: 'status-connected' }
                };
                
                const statusInfo = statusMap[status];
                this.statusIndicator.className = `status-indicator ${statusInfo.class}`;
                this.statusIndicator.querySelector('span:last-child').textContent = statusInfo.text;
            }

            showProgress(show) {
                this.progressContainer.style.display = show ? 'block' : 'none';
                if (!show) {
                    this.progressFill.style.width = '0%';
                }
            }

            updateProgress(percentage) {
                this.progressFill.style.width = `${percentage}%`;
            }

            showMessage(type, message) {
                this.clearMessages();
                
                const messageEl = document.createElement('div');
                messageEl.className = `message message-${type}`;
                
                const iconMap = {
                    error: '!',
                    success: '‚úì',
                    info: 'i'
                };
                
                messageEl.innerHTML = `
                    <div class="message-icon">${iconMap[type]}</div>
                    <div>${message}</div>
                `;
                
                this.modelMessages.appendChild(messageEl);
                
                // Auto-remove after 5 seconds for non-error messages
                if (type !== 'error') {
                    setTimeout(() => {
                        if (messageEl.parentNode) {
                            messageEl.remove();
                        }
                    }, 5000);
                }
            }

            clearMessages() {
                this.modelMessages.innerHTML = '';
            }

            applyPreset(presetName) {
                const preset = this.presets[presetName];
                if (preset) {
                    this.customEndpoint.value = preset.baseUrl;
                    this.customKey.value = preset.apiKey;
                    this.showMessage('info', `Applied ${preset.name} preset. Click "Discover Models" to load available models.`);
                }
            }

            async discoverModels() {
                const endpoint = this.customEndpoint.value.trim();
                if (!endpoint) {
                    this.showMessage('error', 'Please enter an endpoint URL first');
                    return;
                }

                try {
                    this.discoverModelsBtn.disabled = true;
                    this.discoverModelsBtn.innerHTML = '<span class="loading-spinner"></span>Discovering...';
                    this.clearMessages();

                    const modelsUrl = endpoint.replace(/\/+$/, '') + '/models';
                    const headers = {
                        'Content-Type': 'application/json'
                    };

                    const apiKey = this.customKey.value.trim();
                    if (apiKey) {
                        headers['Authorization'] = `Bearer ${apiKey}`;
                    }

                    const response = await fetch(modelsUrl, { headers });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    if (data.data && Array.isArray(data.data)) {
                        this.populateDiscoveredModels(data.data);
                        this.showMessage('success', `Found ${data.data.length} models`);
                    } else {
                        throw new Error('Invalid response format');
                    }

                } catch (error) {
                    console.error('Error discovering models:', error);
                    this.showMessage('error', `Failed to discover models: ${error.message}`);
                } finally {
                    this.discoverModelsBtn.disabled = false;
                    this.discoverModelsBtn.innerHTML = 'üîç Discover Models';
                }
            }

            populateDiscoveredModels(models) {
                // Clear existing options
                this.customModelSelect.innerHTML = '<option value="">Select a model...</option>';
                this.discoveredModels.innerHTML = '';

                if (models.length === 0) {
                    this.showMessage('info', 'No models found at this endpoint');
                    return;
                }

                // Populate dropdown
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    this.customModelSelect.appendChild(option);
                });

                // Populate list for display
                models.forEach(model => {
                    const item = document.createElement('div');
                    item.className = 'model-item';
                    item.textContent = model.id;
                    item.addEventListener('click', () => {
                        this.customModelSelect.value = model.id;
                        this.discoveredModels.style.display = 'none';
                        this.validateCustomConfig();
                    });
                    this.discoveredModels.appendChild(item);
                });

                this.discoveredModels.style.display = 'block';
            }

            async handleWebLLMModelChange() {
                const selectedModel = this.webllmModelSelect.value;
                if (!selectedModel) {
                    this.updateStatus('disconnected');
                    this.testPromptBtn.disabled = true;
                    this.updateEnhancementButtons();
                    return;
                }

                try {
                    this.updateStatus('connecting');
                    this.showProgress(true);
                    this.clearMessages();
                    
                    // Create engine with progress callback
                    this.engine = await CreateMLCEngine(selectedModel, {
                        initProgressCallback: (progress) => {
                            this.updateProgress(progress.progress * 100);
                            if (progress.text) {
                                this.showMessage('info', `Loading: ${progress.text}`);
                            }
                        }
                    });

                    this.updateStatus('connected');
                    this.showProgress(false);
                    this.testPromptBtn.disabled = false;
                    this.showMessage('success', `Model "${selectedModel}" loaded successfully!`);
                    this.updateEnhancementButtons();
                    
                } catch (error) {
                    console.error('Error loading model:', error);
                    this.updateStatus('disconnected');
                    this.showProgress(false);
                    this.testPromptBtn.disabled = true;
                    this.showMessage('error', `Failed to load model: ${error.message}`);
                    this.updateEnhancementButtons();
                }
            }

            async testPrompt() {
                if (!this.currentPrompt) {
                    this.showMessage('error', 'Please generate a prompt first.');
                    return;
                }

                try {
                    this.testPromptBtn.disabled = true;
                    this.testPromptBtn.innerHTML = '<span class="loading-spinner"></span>Generating Story...';
                    this.aiResponse.innerHTML = '<div class="placeholder"><div class="placeholder-icon">‚è≥</div><div class="placeholder-title">AI is writing...</div><div class="placeholder-text">Please wait while the AI generates your story.</div></div>';

                    const testPrompt = this.createTestPrompt();
                    const response = await this.callAI(testPrompt);
                    this.aiResponse.textContent = response;
                    
                } catch (error) {
                    console.error('Error generating story:', error);
                    this.aiResponse.innerHTML = `<div class="message message-error"><div class="message-icon">!</div><div>Error generating story: ${error.message}</div></div>`;
                } finally {
                    this.testPromptBtn.disabled = false;
                    this.testPromptBtn.innerHTML = 'üß™ Test Generated Prompt';
                }
            }

            async analyzePrompt() {
                if (!this.currentPrompt) return;
                
                try {
                    this.analyzePromptBtn.disabled = true;
                    this.analyzePromptBtn.innerHTML = '<span class="loading-spinner"></span>Analyzing...';
                    
                    const analysisPrompt = `Analyze this story writing prompt and provide detailed feedback on its strengths, weaknesses, and suggestions for improvement:

${this.currentPrompt}

Please provide:
1. Overall assessment of the prompt quality
2. Specific strengths
3. Areas for improvement
4. Suggestions for enhancement
5. Missing elements that could be added`;

                    const response = await this.callAI(analysisPrompt);
                    this.promptEnhancementResult.textContent = response;
                    
                } catch (error) {
                    this.promptEnhancementResult.innerHTML = `<div class="message message-error"><div class="message-icon">!</div><div>Error analyzing prompt: ${error.message}</div></div>`;
                } finally {
                    this.analyzePromptBtn.disabled = false;
                    this.analyzePromptBtn.innerHTML = 'üîç Analyze Prompt';
                }
            }

            async improvePrompt() {
                if (!this.currentPrompt) return;
                
                try {
                    this.improvePromptBtn.disabled = true;
                    this.improvePromptBtn.innerHTML = '<span class="loading-spinner"></span>Improving...';
                    
                    const improvementPrompt = `Take this story writing prompt and enhance it to be more comprehensive, specific, and effective. Add missing elements, improve clarity, and make it more actionable for AI story generation:

ORIGINAL PROMPT:
${this.currentPrompt}

Please provide an IMPROVED VERSION that:
1. Is more specific and detailed
2. Includes better examples
3. Has clearer instructions
4. Adds any missing important elements
5. Maintains the original intent while enhancing effectiveness

Return only the improved prompt, formatted clearly.`;

                    const response = await this.callAI(improvementPrompt);
                    this.showPromptComparison(this.currentPrompt, response);
                    
                } catch (error) {
                    this.promptEnhancementResult.innerHTML = `<div class="message message-error"><div class="message-icon">!</div><div>Error improving prompt: ${error.message}</div></div>`;
                } finally {
                    this.improvePromptBtn.disabled = false;
                    this.improvePromptBtn.innerHTML = '‚ö° Improve Prompt';
                }
            }

            showPromptComparison(original, improved) {
                this.promptEnhancementResult.innerHTML = `
                    <div class="comparison-container">
                        <div class="comparison-panel">
                            <div class="comparison-header">Original Prompt</div>
                            <div class="comparison-content">${original.substring(0, 500)}...</div>
                        </div>
                        <div class="comparison-panel">
                            <div class="comparison-header">Improved Prompt</div>
                            <div class="comparison-content">${improved.substring(0, 500)}...</div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="app.useImprovedPrompt(\`${improved.replace(/`/g, '\\`')}\`)" style="margin-top: var(--spacing-md);">Use Improved Prompt</button>
                `;
            }

            useImprovedPrompt(improvedPrompt) {
                this.currentPrompt = improvedPrompt;
                this.output.textContent = improvedPrompt;
                this.copyBtn.style.display = 'block';
                this.enhanceBtn.style.display = 'block';
                this.promptEnhancementResult.innerHTML = '<div class="message message-success"><div class="message-icon">‚úì</div><div>Improved prompt has been applied!</div></div>';
            }

            async extendStory() {
                const storyText = this.storyInput.value.trim();
                if (!storyText) return;
                
                try {
                    this.extendStoryBtn.disabled = true;
                    this.extendStoryBtn.innerHTML = '<span class="loading-spinner"></span>Extending...';
                    
                    const extensionPrompt = `Continue this story naturally, maintaining the same style, tone, and character voices. Add 2-3 more paragraphs that advance the plot and develop the characters:

EXISTING STORY:
${storyText}

CONTINUATION:`;

                    const response = await this.callAI(extensionPrompt);
                    this.storyEnhancementResult.textContent = response;
                    
                } catch (error) {
                    this.storyEnhancementResult.innerHTML = `<div class="message message-error"><div class="message-icon">!</div><div>Error extending story: ${error.message}</div></div>`;
                } finally {
                    this.extendStoryBtn.disabled = false;
                    this.extendStoryBtn.innerHTML = 'üìñ Extend Story';
                }
            }

            async fixContinuity() {
                const storyText = this.storyInput.value.trim();
                if (!storyText) return;
                
                try {
                    this.fixContinuityBtn.disabled = true;
                    this.fixContinuityBtn.innerHTML = '<span class="loading-spinner"></span>Fixing...';
                    
                    const continuityPrompt = `Analyze this story for continuity errors, plot holes, character inconsistencies, and timeline issues. Then provide a corrected version:

STORY TO ANALYZE:
${storyText}

Please:
1. Identify any continuity errors
2. Note character inconsistencies
3. Check for timeline issues
4. Provide a corrected version
5. Explain what was fixed

ANALYSIS AND CORRECTIONS:`;

                    const response = await this.callAI(continuityPrompt);
                    this.storyEnhancementResult.textContent = response;
                    
                } catch (error) {
                    this.storyEnhancementResult.innerHTML = `<div class="message message-error"><div class="message-icon">!</div><div>Error fixing continuity: ${error.message}</div></div>`;
                } finally {
                    this.fixContinuityBtn.disabled = false;
                    this.fixContinuityBtn.innerHTML = 'üîß Fix Continuity';
                }
            }

            async callAI(prompt) {
                switch (this.currentMode) {
                    case 'webllm':
                        return await this.callWebLLM(prompt);
                    case 'openai':
                        return await this.callOpenAI(prompt);
                    case 'custom':
                        return await this.callCustomEndpoint(prompt);
                    default:
                        throw new Error('No AI mode selected');
                }
            }

            async callWebLLM(prompt) {
                if (!this.engine) {
                    throw new Error('WebLLM model not loaded');
                }

                const response = await this.engine.chat.completions.create({
                    messages: [
                        {
                            role: "system",
                            content: "You are an expert writing assistant and story analyst. Provide detailed, helpful feedback and improvements."
                        },
                        {
                            role: "user", 
                            content: prompt
                        }
                    ],
                    max_tokens: 1000,
                    temperature: 0.7
                });

                return response.choices[0].message.content;
            }

            async callOpenAI(prompt) {
                const apiKey = this.openaiKey.value.trim();
                const model = this.openaiModelSelect.value;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            {
                                role: "system",
                                content: "You are an expert writing assistant and story analyst. Provide detailed, helpful feedback and improvements."
                            },
                            {
                                role: "user",
                                content: prompt
                            }
                        ],
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || `HTTP ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }

            async callCustomEndpoint(prompt) {
                const endpoint = this.customEndpoint.value.trim();
                const model = this.customModelSelect.value;
                const apiKey = this.customKey.value.trim();

                const chatUrl = endpoint.replace(/\/+$/, '') + '/chat/completions';
                const headers = {
                    'Content-Type': 'application/json'
                };

                if (apiKey) {
                    headers['Authorization'] = `Bearer ${apiKey}`;
                }

                const response = await fetch(chatUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            {
                                role: "system",
                                content: "You are an expert writing assistant and story analyst. Provide detailed, helpful feedback and improvements."
                            },
                            {
                                role: "user",
                                content: prompt
                            }
                        ],
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }

            createTestPrompt() {
                const formData = new FormData(this.form);
                const genre = formData.get('genre');
                const tone = formData.get('tone');
                const theme = formData.get('theme') || formData.get('customTheme');
                
                let testPrompt = `Write the opening 2-3 paragraphs of a ${this.getGenreDescription(genre)} story with a ${tone} tone.`;
                
                if (theme) {
                    testPrompt += ` The central theme should be ${theme}.`;
                }
                
                testPrompt += ` Create compelling characters, vivid setting, and immediate engagement. Focus on showing rather than telling.`;
                
                return testPrompt;
            }

            handleSubmit(e) {
                e.preventDefault();
                const formData = new FormData(this.form);
                const prompt = this.generatePrompt(formData);
                this.currentPrompt = prompt;
                this.displayPrompt(prompt);
                this.updateEnhancementButtons();
            }

            generatePrompt(formData) {
                const genre = formData.get('genre');
                const subgenre = formData.get('subgenre');
                const length = formData.get('length');
                const perspective = formData.get('perspective');
                const tone = formData.get('tone');
                const theme = formData.get('theme') || formData.get('customTheme');
                const features = formData.getAll('features');

                let prompt = `# EXPERT STORY WRITING COMMAND

You are an expert storyteller tasked with creating a compelling ${this.getGenreDescription(genre)} story. Follow these comprehensive guidelines to craft a professional-quality narrative.

## STORY SPECIFICATIONS
- **Genre**: ${this.getGenreDescription(genre)}`;

                if (subgenre) {
                    prompt += `\n- **Subgenre**: ${subgenre.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
                }

                prompt += `
- **Length**: ${this.getLengthDescription(length)}
- **Perspective**: ${this.getPerspectiveDescription(perspective)}
- **Tone**: ${this.getToneDescription(tone)}`;

                if (theme) {
                    prompt += `\n- **Central Theme**: ${theme}`;
                }

                prompt += `

## CORE WRITING PRINCIPLES

### Structure Requirements
1. **Opening Hook**: Begin with immediate engagement - action, compelling dialogue, or intriguing situation
2. **Three-Act Structure**: Setup (25%), Confrontation (50%), Resolution (25%)
3. **Scene-Sequel Pattern**: Each scene must have goal, conflict, disaster followed by reaction, dilemma, decision
4. **Rising Action**: Escalate conflicts progressively with each chapter/section
5. **Satisfying Resolution**: Address all major plot threads and character arcs

### Character Development Mandates
- Create multi-dimensional protagonists with clear motivations, flaws, and growth arcs
- Establish compelling antagonists with understandable (if not sympathetic) motivations
- Use character actions and dialogue to reveal personality rather than exposition
- Ensure each major character has a distinct voice and speech pattern
- Show character change through actions, not just internal monologue`;

                if (features.includes('characters')) {
                    prompt += `

### ADVANCED CHARACTER TECHNIQUES
- **Character Arc Mapping**: Plan how each major character changes from beginning to end
- **Motivation Hierarchy**: Establish surface wants vs. deeper needs for each character
- **Backstory Integration**: Weave character history naturally into present action
- **Relationship Dynamics**: Create complex, evolving relationships between characters
- **Internal Conflict**: Give protagonists internal struggles that mirror external conflicts`;
                }

                if (features.includes('dialogue')) {
                    prompt += `

### DIALOGUE MASTERY
Each conversation must serve multiple purposes: advance plot, reveal character, create tension.

**Example Techniques:**
- **Subtext**: Characters say one thing but mean another
- **Conflict-Driven**: Every dialogue should contain some form of tension
- **Voice Distinction**: Each character should have unique speech patterns
- **Realistic Flow**: Include interruptions, incomplete thoughts, natural rhythms

**Sample Dialogue Styles:**
${this.templates.dialogue.conflict}

${this.templates.dialogue.revelation}

**Dialogue Guidelines:**
- Avoid exposition dumps in conversation
- Use action beats to break up long speeches
- Make every line count - cut unnecessary pleasantries
- Read dialogue aloud to test naturalness`;
                }

                if (features.includes('settings')) {
                    prompt += `

### IMMERSIVE SETTING CREATION
Settings should function as characters in your story, influencing mood and plot.

**Setting Description Examples:**
${this.getSettingExample(genre)}

**Setting Integration Techniques:**
- Use sensory details beyond just visual (sounds, smells, textures)
- Show how environment affects character behavior and emotions
- Make setting relevant to plot - it should influence or reflect story events
- Avoid info-dumping descriptions - weave details into action
- Use setting to create atmosphere and foreshadow events`;
                }

                if (features.includes('pacing')) {
                    prompt += `

### PACING MASTERY
Control story rhythm through sentence structure, scene length, and tension management.

**Pacing Guidelines by Section:**
- **Opening (First 10%)**: ${this.templates.pacing.opening}
- **Development (10-75%)**: ${this.templates.pacing.middle}
- **Climax (75-90%)**: ${this.templates.pacing.climax}
- **Resolution (90-100%)**: ${this.templates.pacing.resolution}

**Pacing Techniques:**
- Vary sentence length: short for tension, longer for reflection
- Use white space and paragraph breaks for dramatic effect
- Alternate between action scenes and quieter character moments
- End chapters/sections with hooks or cliffhangers
- Control information release to maintain reader engagement`;
                }

                if (features.includes('plotTwists')) {
                    prompt += `

### PLOT TWIST INTEGRATION
Incorporate unexpected but logical plot developments that recontextualize earlier events.

**Potential Plot Twist Ideas for ${this.getGenreDescription(genre)}:**`;
                    
                    const twists = this.templates.plotTwists[genre] || this.templates.plotTwists.general;
                    twists.forEach(twist => {
                        prompt += `\n- ${twist}`;
                    });

                    prompt += `

**Plot Twist Guidelines:**
- Foreshadow twists subtly without telegraphing them
- Ensure twists feel inevitable in hindsight
- Use misdirection to guide reader assumptions
- Make twists serve character development, not just shock value
- Plant clues that support the twist throughout the story`;
                }

                if (features.includes('worldbuilding')) {
                    prompt += `

### WORLD BUILDING EXCELLENCE
Create a believable, consistent world that supports your narrative.

**World Building Elements:**
- **Physical Laws**: Establish rules for how your world works (magic systems, technology, physics)
- **Social Structure**: Define government, class systems, cultural norms
- **History**: Create backstory that influences current events
- **Geography**: Design locations that affect plot and character movement
- **Culture**: Develop customs, beliefs, languages that feel authentic
- **Economy**: Understand how people make living and trade

**Integration Techniques:**
- Reveal world details through character actions and observations
- Make world rules consistent throughout the story
- Use world elements to create conflict and drive plot
- Avoid exposition dumps - show don't tell world details`;
                }

                if (features.includes('symbolism')) {
                    prompt += `

### SYMBOLISM AND METAPHOR
Weave deeper meaning through symbolic elements and metaphorical language.

**Symbolic Techniques:**
- **Object Symbolism**: Use recurring objects to represent themes or character states
- **Color Symbolism**: Employ color associations to reinforce mood and meaning
- **Natural Symbolism**: Use weather, seasons, and landscapes to reflect internal states
- **Action Symbolism**: Make character actions represent larger concepts
- **Structural Symbolism**: Use story structure itself to reinforce themes

**Implementation Guidelines:**
- Keep symbolism subtle and organic to the story
- Ensure symbols serve the narrative, not the other way around
- Use recurring motifs to create cohesion
- Allow readers to discover symbolic meaning naturally`;
                }

                if (features.includes('conflict')) {
                    prompt += `

### CONFLICT ARCHITECTURE
Layer multiple types of conflict to create rich, engaging narratives.

**Conflict Types:**
- **Person vs. Person**: Direct confrontation between characters
- **Person vs. Self**: Internal struggles, moral dilemmas, identity crises
- **Person vs. Society**: Individual against social norms, institutions, or expectations
- **Person vs. Nature**: Survival against natural forces or environmental challenges
- **Person vs. Technology**: Struggles with technological systems or artificial intelligence
- **Person vs. Fate/Destiny**: Fighting against predetermined outcomes or cosmic forces

**Conflict Integration:**
- Layer multiple conflict types for complexity
- Ensure conflicts escalate throughout the story
- Make conflicts personal and meaningful to characters
- Use external conflicts to reveal internal struggles
- Resolve conflicts in ways that show character growth`;
                }

                prompt += `

## WRITING EXECUTION COMMANDS

### Style Requirements
- **Show Don't Tell**: Demonstrate character emotions and world details through action and dialogue
- **Active Voice**: Use active construction for dynamic, engaging prose
- **Specific Details**: Choose concrete, specific nouns and verbs over generic ones
- **Sensory Engagement**: Include details that appeal to all five senses
- **Varied Sentence Structure**: Mix short, punchy sentences with longer, flowing ones

### Quality Checkpoints
1. **Opening Pages**: Hook reader immediately with compelling situation or character voice
2. **Chapter Endings**: End each section with tension, questions, or forward momentum
3. **Character Consistency**: Ensure character actions align with established personality
4. **Plot Logic**: Verify all story events follow logically from established rules
5. **Emotional Resonance**: Every scene should evoke some emotional response

### Final Polish Requirements
- **Read Aloud**: Test dialogue and prose rhythm by reading sections aloud
- **Consistency Check**: Verify character names, timeline, world rules remain consistent
- **Tension Maintenance**: Ensure each scene contains some form of conflict or tension
- **Theme Integration**: Weave central themes naturally throughout without preaching

## EXECUTION DIRECTIVE
Begin writing immediately. Start with a compelling opening that establishes character, setting, and conflict within the first few paragraphs. Focus on creating an immersive experience that draws readers into your story world from the very first sentence.

Remember: Great stories are rewritten, not just written. Plan for multiple drafts and revisions to achieve professional quality.`;

                return prompt;
            }

            getGenreDescription(genre) {
                const descriptions = {
                    general: 'General Fiction',
                    fantasy: 'Fantasy',
                    scifi: 'Science Fiction',
                    mystery: 'Mystery/Thriller',
                    romance: 'Romance',
                    horror: 'Horror',
                    historical: 'Historical Fiction',
                    literary: 'Literary Fiction',
                    cyberpunk: 'Cyberpunk',
                    'urban-fantasy': 'Urban Fantasy',
                    steampunk: 'Steampunk',
                    dystopian: 'Dystopian',
                    western: 'Western',
                    adventure: 'Adventure',
                    comedy: 'Comedy',
                    crime: 'Crime',
                    psychological: 'Psychological',
                    supernatural: 'Supernatural'
                };
                return descriptions[genre] || 'General Fiction';
            }

            getLengthDescription(length) {
                const descriptions = {
                    flash: 'Flash Fiction (< 1,000 words)',
                    short: 'Short Story (1,000-5,000 words)',
                    novelette: 'Novelette (7,500-17,500 words)',
                    novella: 'Novella (17,500-40,000 words)',
                    novel: 'Novel (40,000+ words)',
                    epic: 'Epic Novel (100,000+ words)'
                };
                return descriptions[length] || 'Short Story';
            }

            getPerspectiveDescription(perspective) {
                const descriptions = {
                    first: 'First Person - intimate, personal narrative voice',
                    'third-limited': 'Third Person Limited - focused through one character\'s perspective',
                    'third-omniscient': 'Third Person Omniscient - all-knowing narrator with access to multiple viewpoints',
                    second: 'Second Person - direct address to reader ("You do this...")',
                    multiple: 'Multiple POV - alternating between different character perspectives',
                    epistolary: 'Epistolary - told through letters, documents, or diary entries',
                    stream: 'Stream of Consciousness - unfiltered flow of thoughts and perceptions'
                };
                return descriptions[perspective] || 'Third Person Limited';
            }

            getToneDescription(tone) {
                const descriptions = {
                    dramatic: 'Dramatic - serious, emotionally intense',
                    humorous: 'Humorous - light-hearted, comedic elements',
                    dark: 'Dark/Gritty - serious themes, realistic consequences',
                    uplifting: 'Uplifting - hopeful, inspiring',
                    mysterious: 'Mysterious - suspenseful, enigmatic',
                    romantic: 'Romantic - focus on relationships and emotional connections',
                    satirical: 'Satirical - using humor to critique society or human nature',
                    melancholic: 'Melancholic - thoughtful, bittersweet, reflective',
                    whimsical: 'Whimsical - playful, imaginative, fantastical',
                    noir: 'Noir - cynical, morally ambiguous, atmospheric',
                    epic: 'Epic - grand scale, heroic, larger-than-life',
                    intimate: 'Intimate - personal, character-focused, emotional depth',
                    surreal: 'Surreal - dreamlike, bizarre, reality-bending',
                    philosophical: 'Philosophical - thought-provoking, existential themes',
                    nostalgic: 'Nostalgic - wistful, longing for the past'
                };
                return descriptions[tone] || 'Dramatic';
            }

            getSettingExample(genre) {
                if (genre === 'fantasy') return this.templates.settings.fantasy;
                if (genre === 'scifi') return this.templates.settings.scifi;
                if (genre === 'historical') return this.templates.settings.historical;
                if (genre === 'cyberpunk') return this.templates.settings.cyberpunk;
                return this.templates.settings.urban;
            }

            displayPrompt(prompt) {
                this.output.textContent = prompt;
                this.copyBtn.style.display = 'block';
                this.enhanceBtn.style.display = 'block';
            }

            async copyToClipboard() {
                try {
                    await navigator.clipboard.writeText(this.output.textContent);
                    const originalText = this.copyBtn.textContent;
                    this.copyBtn.textContent = '‚úÖ Copied!';
                    this.copyBtn.classList.remove('btn-success');
                    this.copyBtn.classList.add('btn-success');
                    
                    setTimeout(() => {
                        this.copyBtn.textContent = originalText;
                        this.copyBtn.classList.remove('btn-success');
                        this.copyBtn.classList.add('btn-success');
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = this.output.textContent;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    this.copyBtn.textContent = '‚úÖ Copied!';
                    setTimeout(() => {
                        this.copyBtn.textContent = 'üìã Copy';
                    }, 2000);
                }
            }
        }

        // Global function for API key visibility toggle
        window.toggleApiKeyVisibility = function(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        };

        // Global app instance for enhanced prompt functionality
        let app;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            app = new StoryPromptBuilderEnhancedUX();
            window.app = app; // Make available globally for enhanced prompt features
        });
    </script>
</body>
</html>